<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam - DevMasterMind</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .secure-exam-container {
            min-height: 100vh;
        }

        .exam-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .timer-bar {
            background: linear-gradient(135deg, #1a2b3e 0%, #2c3e50 100%);
            color: white;
            padding: 10px;
            text-align: center;
        }

        .exam-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            padding: 20px;
        }

        .option-item label {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-item label:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .option-item input[type="radio"] {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }

        .bg-light {
            background-color: #e3f2fd !important;
            border-color: #2196f3 !important;
        }

        .security-status .badge {
            padding: 8px 12px;
            font-size: 0.9rem;
            margin: 0 5px;
        }

        .progress {
            height: 10px;
            border-radius: 10px;
        }

        /* ADDED: Camera indicator styling */
        .camera-indicator {
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .camera-indicator i {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="secure-exam-container" @contextmenu.prevent>
            <!-- Header -->
            <div class="exam-header">
                <div class="d-flex justify-content-between align-items-center p-3">
                    <div>
                        <h4 class="mb-0" id="examTitle">Loading Exam...</h4>
                        <small class="text-muted" id="examRole"></small>
                    </div>
                    <div class="security-status d-flex align-items-center">
                        <!-- ADDED: Camera indicator -->
                        <div class="camera-indicator" id="cameraIndicator" style="display: none;">
                            <i class="fas fa-video"></i>
                            <span>Camera Active</span>
                        </div>
                        <span class="badge badge-warning mr-2" id="violationBadge" style="display: none;">
                            ⚠️ Violations: <span id="violationCount">0</span>/3
                        </span>
                        <span class="badge badge-success">
                            <i class="fas fa-shield-alt mr-1"></i> Secure Mode
                        </span>
                    </div>
                </div>

                <!-- Timer -->
                <div class="timer-bar">
                    <h5 class="mb-0">
                        Time Remaining:
                        <span id="timer">00:00</span>
                    </h5>
                </div>
            </div>

            <!-- Main Content -->
            <div class="exam-content" id="examContent">
                <div class="progress-section mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progress: <span id="answeredCount">0</span>/<span id="totalQuestions">0</span>
                            Questions</span>
                        <span id="progressPercentage">0% Complete</span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="questionsContainer"></div>

                <div class="text-center mt-4">
                    <button id="submitBtn" class="btn btn-success btn-lg" onclick="submitExam()" disabled>
                        <i class="fas fa-check-circle mr-2"></i>
                        Submit Exam (<span id="submitCount">0</span>/<span id="submitTotal">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let examData = null;
        let answers = [];
        let timeRemaining = 0;
        let timerInterval = null;
        let violations = 0;
        let cameraActive = false;
        const MAX_VIOLATIONS = 3;

        function loadExamData() {
            try {
                const stored = localStorage.getItem('current_exam');
                if (stored) {
                    examData = JSON.parse(stored);
                    timeRemaining = (examData.duration || 60) * 60;
                    answers = new Array(examData.questions.length).fill(null);
                    renderExam();
                    startTimer();
                    initSecurity();
                    requestCameraPermission();
                } else {
                    document.getElementById('examContent').innerHTML = `
            <div class="text-center p-5">
              <h3 class="text-danger">No exam data found!</h3>
              <p>Please close this window and try again.</p>
            </div>
          `;
                }
            } catch (e) {
                console.error('Error loading exam:', e);
            }
        }

        function requestCameraPermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        cameraActive = true;
                        document.getElementById('cameraIndicator').style.display = 'inline-flex';
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function (err) {
                        console.log('Camera permission denied or not available');
                        recordViolation('Camera access denied');
                    });
            } else {
                console.log('Camera not supported');
            }
        }

        // Render exam questions
        function renderExam() {
            document.getElementById('examTitle').textContent = examData.title;
            document.getElementById('examRole').textContent = examData.role;
            document.getElementById('totalQuestions').textContent = examData.questions.length;
            document.getElementById('submitTotal').textContent = examData.questions.length;

            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            examData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';

                let optionsHtml = '';
                question.options.forEach((option, optIndex) => {
                    optionsHtml += `
            <div class="option-item">
              <label class="${answers[index] === option.value ? 'bg-light' : ''}">
                <input 
                  type="radio" 
                  name="q${index}" 
                  value="${option.value}"
                  onchange="answerChanged(${index}, '${option.value}')"
                  ${answers[index] === option.value ? 'checked' : ''}
                >
                <span>${option.text}</span>
              </label>
            </div>
          `;
                });

                questionDiv.innerHTML = `
          <p class="font-weight-bold mb-3">${index + 1}. ${question.text}</p>
          <div class="options ml-3">
            ${optionsHtml}
          </div>
        `;
                container.appendChild(questionDiv);
            });
        }

        window.answerChanged = function (index, value) {
            answers[index] = value;
            updateProgress();

            const labels = document.querySelectorAll(`input[name="q${index}"]`);
            labels.forEach((input, i) => {
                const label = input.closest('label');
                if (input.value === value) {
                    label.classList.add('bg-light');
                } else {
                    label.classList.remove('bg-light');
                }
            });
        };

        function updateProgress() {
            const answered = answers.filter(a => a !== null).length;
            const total = examData.questions.length;
            const percentage = Math.round((answered / total) * 100);

            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('progressPercentage').textContent = percentage + '% Complete';
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('submitCount').textContent = answered;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = answered < total;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();

                    if (timeRemaining === 300) {
                        alert('⚠️ Warning: Only 5 minutes remaining!');
                    }
                } else {
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            const timerSpan = document.getElementById('timer');
            timerSpan.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            if (timeRemaining < 300) {
                timerSpan.style.color = '#ff4444';
            }
        }

        function initSecurity() {
            document.addEventListener('contextmenu', (e) => e.preventDefault());

            document.addEventListener('keydown', (e) => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                    (e.ctrlKey && e.key === 'u')) {
                    e.preventDefault();
                    recordViolation('Developer tools attempted');
                }

                if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'v' || e.key === 'x')) {
                    e.preventDefault();
                    recordViolation('Copy/Paste attempted');
                }
            });

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    recordViolation('Tab switching detected');
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'PrintScreen') {
                    e.preventDefault();
                    recordViolation('Screenshot attempted');
                }
            });

            function enterFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }

            enterFullscreen();

            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    recordViolation('Fullscreen exited');
                    enterFullscreen();
                }
            });
        }

        function recordViolation(reason) {
            violations++;
            document.getElementById('violationCount').textContent = violations;
            document.getElementById('violationBadge').style.display = 'inline-block';

            alert(`⚠️ Security Violation (${violations}/${MAX_VIOLATIONS}): ${reason}`);

            if (violations >= MAX_VIOLATIONS) {
                alert('Maximum violations reached! Exam will be submitted.');
                submitExam();
            }
        }

        window.submitExam = function () {
            clearInterval(timerInterval);

            let correctAnswers = 0;
            examData.questions.forEach((question, index) => {
                if (answers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });

            const score = Math.round((correctAnswers / examData.questions.length) * 100);

            let badge = 'Beginner';
            if (score >= 80) badge = 'Industry Ready';
            else if (score >= 60) badge = 'Strong Junior';
            else if (score >= 40) badge = 'Junior Ready';

            const result = {
                id: Date.now(),
                name: examData.studentName || 'Student',
                email: examData.studentEmail || 'student@example.com',
                examTitle: examData.title,
                date: new Date().toLocaleDateString(),
                score: score,
                badge: badge,
                submittedAt: new Date().toLocaleString(),
                answers: answers,
                timeSpent: (examData.duration * 60) - timeRemaining,
                violations: violations,
                cameraActive: cameraActive
            };

            const userEmail = examData.studentEmail?.replace(/[.@]/g, '_') || 'default';
            const existingResults = JSON.parse(localStorage.getItem(`student_results_${userEmail}`)) || [];
            existingResults.unshift(result);
            localStorage.setItem(`student_results_${userEmail}`, JSON.stringify(existingResults));

            const allResults = JSON.parse(localStorage.getItem('all_student_results')) || [];
            allResults.push(result);
            localStorage.setItem('all_student_results', JSON.stringify(allResults));

            document.getElementById('examContent').innerHTML = `
        <div class="text-center p-5">
          <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
          <h2 class="mt-4">Exam Completed Successfully!</h2>
          <h3 class="text-primary">Your Score: ${score}%</h3>
          <h4><span class="badge badge-success p-3">${badge}</span></h4>
          <p class="mt-4">You can close this window now.</p>
          <button class="btn btn-primary mt-3" onclick="window.close()">Close Window</button>
        </div>
      `;
        }

        window.onload = loadExamData;
    </script>
</body>

</html>